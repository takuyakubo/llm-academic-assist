# 全体アーキテクチャ: LLM学術文書支援システム

## 1. アーキテクチャ概要

LLM学術文書支援システムは、マイクロサービスベースのアーキテクチャを採用し、フロントエンドとバックエンドを分離した構成としています。各コンポーネントは疎結合に設計されており、独立したスケーリングと進化が可能です。

## 2. 全体構成図

```
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  クライアント層  │  │   CDN / Cache   │  │    認証サービス   │
│                 │  │                 │  │ (Auth0/Firebase) │
└────────┬────────┘  └────────┬────────┘  └────────┬────────┘
         │                    │                    │
         ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────┐
│                   APIゲートウェイ層                       │
│           (API Routes, GraphQL, WebSocket)              │
└────────────────────────────┬──────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────┐
│                  アプリケーション層                       │
├─────────────┬─────────────┬─────────────┬─────────────┐
│プロジェクト管理│ 文書処理    │  LLM連携    │ノート生成    │
│  サービス    │  サービス    │ サービス    │ サービス    │
└─────────────┴─────────────┴─────────────┴─────────────┘
         │             │             │             │
         ▼             ▼             ▼             ▼
┌─────────────────────────────────────────────────────────┐
│                     データ層                             │
├─────────────┬─────────────┬─────────────┬─────────────┐
│ ユーザーDB   │  文書DB     │  知識ベースDB │ 会話履歴DB  │
└─────────────┴─────────────┴─────────────┴─────────────┘
         │             │             │             │
         ▼             ▼             ▼             ▼
┌─────────────────────────────────────────────────────────┐
│                    ストレージ層                          │
├─────────────────────┐  ┌─────────────────────────────┐
│  オブジェクトストレージ │  │       全文検索エンジン      │
│  (原文書、生成物)     │  │     (Elasticsearch)        │
└─────────────────────┘  └─────────────────────────────┘
```

## 3. レイヤー構成

### 3.1 クライアント層
- **フロントエンドアプリケーション**: Next.js 14+, React 18+, TypeScript
- **主要機能**:
  - ユーザーインターフェース (UI)
  - 状態管理 (Zustand/Redux)
  - フォーム処理 (React Hook Form)
  - API通信 (TanStack Query)
  - ルーティング (Next.js App Router)

### 3.2 APIゲートウェイ層
- **Next.js API Routes / FastAPI**
- **主要機能**:
  - ルーティング
  - 認証・認可
  - レート制限
  - リクエスト/レスポンス変換
  - キャッシュ制御
  - WebSocketハンドリング

### 3.3 アプリケーション層
- **マイクロサービス群**: Python/FastAPI
- **主要サービス**:
  - プロジェクト管理サービス
  - 文書処理サービス
  - LLM連携サービス
  - ノート生成サービス
  - 検索・インデックスサービス

### 3.4 データ層
- **データベース**: MongoDB 6.0+
- **主要機能**:
  - ユーザーデータ管理
  - プロジェクト・文書メタデータ管理
  - 構造化された文書コンテンツ保存
  - 会話履歴の保存
  - インデックス管理

### 3.5 ストレージ層
- **オブジェクトストレージ**: AWS S3または同等サービス
- **全文検索エンジン**: Elasticsearch
- **主要機能**:
  - 原文書の保存 (PDF, JPG等)
  - 生成コンテンツの保存
  - 全文検索とベクトル検索機能
  - 大容量データの効率的な保存

### 3.6 外部サービス連携
- **認証サービス**: Auth0/Firebase Authentication
- **LLM API**: Claude API, OpenAI API (GPT-4)
- **その他**: メール送信サービス, 監視サービス

## 4. マイクロサービス詳細

### 4.1 プロジェクト管理サービス
- **責務**:
  - プロジェクトのCRUD操作
  - ユーザー権限管理
  - 文書メタデータ管理
  - 進捗管理

### 4.2 文書処理サービス
- **責務**:
  - PDF/画像のテキスト抽出
  - 数式認識とLaTeX変換
  - 文書構造解析
  - 図表認識と参照管理
  - OCR処理

### 4.3 LLM連携サービス
- **責務**:
  - LLM APIとの通信
  - プロンプト生成と最適化
  - コンテキスト管理
  - ストリーミングレスポンス処理
  - モデル選択ロジック

### 4.4 ノート生成サービス
- **責務**:
  - 要約生成
  - 学習ノート作成
  - マークダウン/LaTeXレンダリング
  - エクスポート処理

### 4.5 検索・インデックスサービス
- **責務**:
  - 全文検索機能
  - ベクトル検索
  - インデックス構築と管理
  - 検索結果のランキング

## 5. データフロー

### 5.1 文書アップロードと処理フロー
1. ユーザーがWebUIから文書をアップロード
2. ファイルがオブジェクトストレージに保存
3. 文書処理サービスがファイルを解析
   - テキスト抽出
   - 構造解析
   - 数式認識
4. 処理結果がデータベースに保存
5. 検索インデックスが更新
6. ユーザーに処理完了を通知

### 5.2 質問応答フロー
1. ユーザーがチャットインターフェースから質問を送信
2. LLM連携サービスが関連文書コンテキストを取得
3. 適切なプロンプトを生成してLLM APIに送信
4. ストリーミングレスポンスをユーザーに送信
5. 会話履歴を保存

### 5.3 ノート生成フロー
1. ユーザーがノート生成をリクエスト
2. 対象文書/セクションのコンテンツを取得
3. LLM連携サービスを通じて要約と重要ポイントを抽出
4. マークダウン/LaTeXノートを生成
5. 生成物をデータベースに保存
6. ユーザーに完成したノートを表示

## 6. デプロイアーキテクチャ

### 6.1 開発環境
```
┌─────────────────────────────────────────────┐
│               Docker Compose                │
├────────────┬────────────┬────────────┬──────┴───┐
│ Frontend   │ Backend    │ MongoDB    │ Redis     │
│ Container  │ Container  │ Container  │ Container │
└────────────┴────────────┴────────────┴──────────┘
```

### 6.2 本番環境 (AWS)
```
┌─────────────────────┐    ┌────────────────────┐
│  Amazon CloudFront  │    │  AWS Cognito       │
│  (CDN)              │    │  (認証)             │
└──────────┬──────────┘    └─────────┬──────────┘
           │                         │
           ▼                         ▼
┌─────────────────────┐    ┌────────────────────┐
│  AWS S3/Vercel      │    │  AWS ECS/Lambda    │
│  (フロントエンド)    │    │  (バックエンド)     │
└──────────┬──────────┘    └─────────┬──────────┘
           │                         │
           └─────────────┬───────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
┌───────────────┐ ┌─────────────┐ ┌───────────────┐
│ Amazon S3     │ │ MongoDB     │ │ AWS           │
│ (オブジェクト  │ │ Atlas       │ │ Elasticsearch │
│  ストレージ)   │ │ (データベース)│ │ Service      │
└───────────────┘ └─────────────┘ └───────────────┘
```

## 7. セキュリティアーキテクチャ

### 7.1 認証・認可フロー
```
[ユーザー] → [ログイン要求] → [認証サービス] → [JWT発行]
                                   ↓
[リソースアクセス] ← [JWT検証] ← [リクエスト+JWT]
      ↓
[アクセス制御] → [ユーザーロール/権限確認] → [許可/拒否]
```

### 7.2 データ保護戦略
- **転送中データ保護**: TLS 1.3による通信暗号化
- **保存データ保護**: AES-256による重要データの暗号化
- **アクセス制御**: RBAC (Role-Based Access Control)
- **秘密情報管理**: AWS Secrets Manager / 環境変数による秘密情報分離
- **バックアップ暗号化**: バックアップデータの自動暗号化

## 8. スケーラビリティと可用性

### 8.1 スケーリング戦略
- **水平スケーリング**: ステートレスなサービスの複数インスタンス配置
- **垂直スケーリング**: データベースなどステートフルサービスのリソース増強
- **自動スケーリング**: 負荷に応じた自動スケールアウト/イン
- **データベースシャーディング**: 大規模データに対応するシャーディング戦略

### 8.2 高可用性設計
- **冗長構成**: 主要コンポーネントの冗長化
- **障害検知**: ヘルスチェックによる障害検知
- **自動復旧**: 障害時の自動フェイルオーバー
- **データレプリケーション**: データの複数リージョン/ゾーンレプリケーション
- **グレースフルデグラデーション**: 一部障害時の劣化運転モード

## 9. 監視とログ管理

### 9.1 監視アーキテクチャ
- **システム監視**: CPU、メモリ、ディスク使用率、ネットワーク
- **アプリケーション監視**: レスポンス時間、エラーレート、スループット
- **ビジネスメトリクス**: ユーザー数、プロジェクト数、処理文書数
- **アラート**: 閾値ベースのアラート、異常検知

### 9.2 ログ管理
- **集中ログ管理**: ELK (Elasticsearch, Logstash, Kibana) スタック
- **ログレベル**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **構造化ログ**: JSON形式の構造化ログ
- **トレーサビリティ**: リクエストIDによる分散トレーシング
