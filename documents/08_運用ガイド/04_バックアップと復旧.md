# バックアップと復旧

## 1. バックアップ戦略概要

LLM学術文書支援システムでは、データの安全性と可用性を確保するために、包括的なバックアップ戦略を実装しています。本ガイドでは、バックアップの種類、スケジュール、保存場所、および復旧手順について説明します。

## 2. バックアップ対象

### 2.1 データベース
- **MongoDB**: ユーザー情報、プロジェクト情報、文書メタデータ
- **Elasticsearch**: 検索インデックス、ベクトルデータ
- **Redis**: セッション情報、キャッシュデータ

### 2.2 ファイルストレージ
- **文書原本**: PDFやその他の形式の原本ファイル
- **生成物**: 自動生成されたノート、コンセプトマップなど
- **アップロード画像**: システム内で使用される画像ファイル

### 2.3 設定ファイル
- **アプリケーション設定**: 各種サービスの設定ファイル
- **サーバー設定**: Webサーバー、アプリケーションサーバーの設定
- **環境変数**: 秘密情報を含む環境変数ファイル

## 3. バックアップの種類と頻度

### 3.1 データベースバックアップ
- **フルバックアップ**: 1日1回（深夜）
- **増分バックアップ**: 4時間ごと
- **トランザクションログ**: 継続的（10分ごと）

### 3.2 ファイルストレージバックアップ
- **フルバックアップ**: 週1回
- **増分バックアップ**: 1日1回
- **変更検知バックアップ**: ファイル変更時即時（重要ファイルのみ）

### 3.3 設定バックアップ
- **システム設定**: 変更時即時
- **定期スナップショット**: 1日1回

## 4. バックアップの保存と管理

### 4.1 保存場所
- **プライマリバックアップ**: オンプレミスまたはクラウドストレージ
- **セカンダリバックアップ**: 地理的に分散したリージョンのストレージ
- **長期アーカイブ**: 低頻度アクセス用ストレージ（Glacier、Archive Blob等）

### 4.2 保存期間
- **日次バックアップ**: 30日間
- **週次バックアップ**: 12週間
- **月次バックアップ**: 12ヶ月間
- **年次バックアップ**: 7年間（必要に応じて）

### 4.3 暗号化と保護
- **保存時暗号化**: AES-256によるバックアップデータの暗号化
- **転送時暗号化**: TLS 1.2+による転送中の暗号化
- **アクセス制御**: 最小権限の原則に基づくアクセス制御

## 5. バックアップの検証

### 5.1 自動検証
- **整合性チェック**: チェックサムによるバックアップファイルの検証
- **自動復元テスト**: サンプルデータを用いた自動復元テスト（週1回）
- **バックアップログ監視**: バックアップジョブの成功/失敗の監視

### 5.2 手動検証
- **完全復元テスト**: テスト環境での完全復元テスト（月1回）
- **選択的復元テスト**: 特定のデータセットの復元テスト（月1回）
- **障害シミュレーション**: さまざまな障害シナリオでの復元テスト（四半期ごと）

## 6. 復旧手順

### 6.1 障害評価
1. 障害の種類と影響範囲の特定
2. 必要な復旧レベルの決定（部分/完全）
3. 復旧目標時間（RTO）と目標復旧時点（RPO）の確認
4. 適切なバックアップソースの選択

### 6.2 データベース復旧
#### MongoDB復旧
1. 復旧用インスタンスの準備
2. mongorestore コマンドによるデータの復元
   ```bash
   mongorestore --host <NEW_HOST> --port <PORT> --username <USER> --password <PASSWORD> --db <DB_NAME> --gzip <BACKUP_PATH>
   ```
3. インデックスの再構築
4. 整合性チェックの実行

#### Elasticsearch復旧
1. 新しいElasticsearchクラスターの準備
2. スナップショットからのインデックス復元
   ```bash
   POST /_snapshot/backup_repository/snapshot_name/_restore
   {
     "indices": "index_name",
     "include_global_state": false
   }
   ```
3. インデックスの検証

### 6.3 ファイルストレージ復旧
1. 復旧対象ファイルの特定
2. バックアップからのファイル復元
   ```bash
   # AWS S3の場合
   aws s3 cp s3://backup-bucket/path/to/backup /restore/location --recursive
   
   # Azure Blobの場合
   az storage blob download-batch -d /restore/location --source backup-container
   ```
3. ファイル権限とメタデータの復元
4. ファイル整合性の確認

### 6.4 設定復旧
1. 設定ファイルの復元
2. 環境変数の復元
3. 設定の検証

### 6.5 サービス復旧
1. サービスの起動順序の確認
2. 依存関係を考慮したサービスの再起動
3. サービス間接続の確認
4. ヘルスチェックの実行

## 7. 運用とメンテナンス

### 7.1 バックアップ監視
- バックアップジョブの成功/失敗のアラート設定
- バックアップサイズと時間のトレンド分析
- ストレージ使用量の監視

### 7.2 定期的なレビュー
- バックアップポリシーの定期的な見直し（半年ごと）
- 復旧手順の定期的な更新
- 新しいバックアップ技術の評価と導入検討

### 7.3 文書化
- バックアップと復旧手順の詳細なドキュメント作成
- 障害復旧テストの結果記録
- トラブルシューティングガイドの維持

## 8. 関連ドキュメント

- [02_管理者ガイド](./02_管理者ガイド.md)
- [03_監視と障害対応](./03_監視と障害対応.md)
- [05_メンテナンス](./05_メンテナンス.md)
- [データベース設計](../03_システム設計/04_データモデル/01_データベース設計.md)
